{% extends 'base.html' %}
{% block title %}Gráficos Personalizados{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Gráfico Personalizado</h2>
    <br>

    <!-- Toast -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
    <br>
    <div class="form-container" style="color:black; background: rgba(255, 255, 255, 0.70);box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);">
        <form id="form-grafico" method="POST" action="{% url 'generar_grafico' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="form-group">
            {{ personalizados_form.tipo_grafico.label_tag }}
            {{ personalizados_form.tipo_grafico }}
        </div>

        <div class="form-group">
            {{ personalizados_form.eje_x.label_tag }}
            {{ personalizados_form.eje_x }}
        </div>

        <div class="form-group" id="instrumento-x-container" style="display: none;">
            {{ personalizados_form.instrumento_x.label_tag }}
            {{ personalizados_form.instrumento_x }}
        </div>

        <div class="form-group">
            {{ personalizados_form.eje_y.label_tag }}
            {{ personalizados_form.eje_y }}
        </div>

        <div class="form-group" id="instrumento-y-container" style="display: none;">
            {{ personalizados_form.instrumento_y.label_tag }}
            {{ personalizados_form.instrumento_y }}
        </div>
        <br>

        <div class="form-group">
            <label>Resaltar período</label><br>
            <label for="fecha_inicio">Desde:</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control">
        </div>

        <div class="form-group">
            <label for="fecha_fin">Hasta:</label>
            <input type="date" id="fecha_fin" name="fecha_fin" class="form-control">
        </div>

        <div class="form-check">
            {{ personalizados_form.agregar_eje_y_secundario }}
            <label class="form-check-label">
                Agregar Eje Y Secundario
            </label>
        </div>
        <br>
        <div class="form-group" id="tipo-grafico-y2-container" style="display: none;">
            {{ personalizados_form.tipo_grafico_y2.label_tag }}
            {{ personalizados_form.tipo_grafico_y2 }}
        </div>

        <div class="form-group" id="eje-y-secundario-container" style="display: none;">
            {{ personalizados_form.eje_y_secundario.label_tag }}
            {{ personalizados_form.eje_y_secundario }}
        </div>

        <div class="form-group" id="instrumento-y2-container" style="display: none;">
            {{ personalizados_form.instrumento_y2.label_tag }}
            {{ personalizados_form.instrumento_y2 }}
        </div>

        <br>
        <div style="text-align: center; ">
                <button class="boton">Graficar</button>
                <style>
                        .boton {
                            background-color: #004080;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            cursor: pointer;
                            transition: background-color 0.3s ease;
                        }

                        .boton:hover {
                            background-color: #0057AAFF;
                            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
                        }
                    </style>
                </div>
    </form>
    </div>
    <div id="loading-message" style="display:none; text-align:center; margin-top: 20px;">
        <p style="font-size: 18px; color: #b5e1f8;">⏳ Generando gráfico, espere un momento...</p>
    </div>
    <div id="grafico-container" class="mt-5"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    $("#id_instrumento_x, #id_instrumento_y, #id_instrumento_y2").select2({
        placeholder: "Seleccione instrumentos...",
        allowClear: true,
        width: "100%"
    });
    //Obtener elementos del formulario
    const ejeX = document.getElementById("id_eje_x");
    const ejeY = document.getElementById("id_eje_y");
    const ejeY2 = document.getElementById("id_eje_y_secundario");
    const checkboxY2 = document.getElementById("id_agregar_eje_y_secundario");

    const instrumentoXContainer = document.getElementById("instrumento-x-container");
    const instrumentoYContainer = document.getElementById("instrumento-y-container");
    const instrumentoY2Container = document.getElementById("instrumento-y2-container");
    const ejeY2Container = document.getElementById("eje-y-secundario-container");
    const tipoGraficoY2Container = document.getElementById("tipo-grafico-y2-container");

    //Datos JSON con los instrumentos disponibles
    const instrumentos = {
        "nivel_piezometrico": JSON.parse('{{ piezometros_json|default:"[]"|escapejs }}'),
        "nivel_freatico": JSON.parse('{{ freatimetros_json|default:"[]"|escapejs }}'),
        "caudal": JSON.parse('{{ aforadores_json|default:"[]"|escapejs }}')
    };


    function actualizarInstrumentos(select, container) {
        const valor = select.value;
        const selectElem = container.querySelector("select");

        // Si es precipitacion, oculta el selector de instrumentos
        if (valor === "precipitacion") {
            container.style.display = "none";
            $(selectElem).val(null).trigger('change');
            return;
        }

        // Si es otro parámetro que sí tiene instrumentos, muestra el selector
        if (instrumentos[valor]) {
            container.style.display = "block";
            selectElem.innerHTML = ''; // Limpiar opciones anteriores
            instrumentos[valor].forEach(inst => {
                let option = new Option(inst.nombre, inst.id, false, false);
                selectElem.appendChild(option);
            });
            $(selectElem).trigger('change');
        } else {
            container.style.display = "none";
            $(selectElem).val(null).trigger('change');
        }
    }

    //Eventos para actualizar los select de instrumentos cuando cambian los valores de los ejes
    ejeX.addEventListener("change", function() {
        actualizarInstrumentos(ejeX, instrumentoXContainer);
    });

    ejeY.addEventListener("change", function() {
        actualizarInstrumentos(ejeY, instrumentoYContainer);
    });

    checkboxY2.addEventListener("change", function() {
        if (checkboxY2.checked) {
            ejeY2Container.style.display = "block";
            tipoGraficoY2Container.style.display = "block";
        } else {
            ejeY2Container.style.display = "none";
            instrumentoY2Container.style.display = "none";
            tipoGraficoY2Container.style.display = "none";
        }
    });

    ejeY2.addEventListener("change", function() {
        actualizarInstrumentos(ejeY2, instrumentoY2Container);
    });

    //Enviar formulario con AJAX y mostrar el gráfico
    document.getElementById("form-grafico").addEventListener("submit", function(event) {
        event.preventDefault();

        document.getElementById("loading-message").style.display = "block";
        document.getElementById("grafico-container").innerHTML = "";

        let formData = new FormData(this);
        let data = {};

        formData.forEach((value, key) => {
            if (data[key]) {
                if (!Array.isArray(data[key])) {
                    data[key] = [data[key]];
                }
                data[key].push(value);
            } else {
                data[key] = value;
            }
        });

        fetch("{% url 'generar_grafico' %}", {
    method: "POST",
    body: new URLSearchParams(formData),
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
    }
})
.then(async response => {
    document.getElementById("loading-message").style.display = "none";

    let data;
    try {
        data = await response.json();
    } catch (e) {
        mostrarToast("❌ No se pudo interpretar la respuesta del servidor.");
        return;
    }

    if (response.ok) {
        if (data.grafico) {
            const graficoContainer = document.getElementById("grafico-container");
            graficoContainer.innerHTML = data.grafico;

            const scripts = graficoContainer.querySelectorAll('script');
            scripts.forEach(script => eval(script.innerHTML));
        } else {
            mostrarToast("⚠️ No se pudo generar el gráfico. Verifique los datos.");
        }
    } else {
        const errores = data.error || {};
        const mensaje = errores.__all__?.[0] || Object.values(errores)[0] || "❌ Error desconocido.";
        mostrarToast(mensaje);
    }
})
.catch(error => {
    document.getElementById("loading-message").style.display = "none";
    mostrarToast("❌ Error en la solicitud: " + error.message);
});
    });
});
function mostrarToast(mensaje, tipo = "error") {
    const toast = document.createElement("div");
    toast.innerHTML = mensaje;
    toast.style.padding = "10px 20px";
    toast.style.marginBottom = "10px";
    toast.style.borderRadius = "10px";
    toast.style.color = "#fff";
    toast.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
    toast.style.transition = "opacity 0.5s ease";
    toast.style.opacity = "1";
    toast.style.backgroundColor = tipo === "error" ? "#dc3545" : "#28a745";

    document.getElementById("toast-container").appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
    }, 4000);
}
</script>

{% endblock %}



